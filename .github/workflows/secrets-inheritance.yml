# =============================================================================
# Reusable Workflow: Secrets Inheritance Patterns
# =============================================================================
# SCHOLAR NOTE:
#   This reusable workflow demonstrates ALL patterns for passing secrets
#   between caller and reusable workflows. It is designed to be called by
#   other workflows to illustrate:
#
#   1. Explicit secret passing (declared in workflow_call.secrets)
#   2. The `secrets: inherit` keyword
#   3. Environment secrets in reusable workflows
#   4. GITHUB_TOKEN behavior across workflow boundaries
#   5. Optional vs required secrets
#
# HOW SECRETS FLOW IN REUSABLE WORKFLOWS:
#
#   Caller Workflow                    Reusable Workflow
#   +------------------+               +------------------+
#   | Repository       |               |                  |
#   | Secrets:         |  -- explicit   | Declared         |
#   |   API_KEY        |  -- passing -> | secrets:         |
#   |   DEPLOY_TOKEN   |               |   api-key        |
#   |   DB_PASSWORD    |               |   deploy-token   |
#   +------------------+               +------------------+
#
#   OR with `secrets: inherit`:
#
#   Caller Workflow                    Reusable Workflow
#   +------------------+               +------------------+
#   | ALL secrets      |  =========>   | ALL secrets      |
#   | passed through   |  (inherit)    | available via    |
#   | automatically    |               | secrets.NAME     |
#   +------------------+               +------------------+
#
# IMPORTANT RULES:
#   - Without explicit passing or inherit, reusable workflows get NO secrets
#   - GITHUB_TOKEN is passed with `inherit` using CALLER's permissions
#   - Environment secrets are NOT passed by `inherit`
#   - Environment secrets require the reusable workflow to set `environment:`
#   - The reusable workflow's `permissions:` key controls its own GITHUB_TOKEN
# =============================================================================

name: Reusable Secrets Inheritance

on:
  workflow_call:
    inputs:
      environment:
        description: >
          Target environment. When set, environment-level secrets become
          available AND environment protection rules are enforced.
        type: string
        required: false
        default: ''
      log-secret-availability:
        description: >
          When true, the workflow will log which secrets are available
          (without revealing values). Useful for debugging secret flow.
        type: boolean
        required: false
        default: true

    # -------------------------------------------------------------------------
    # EXPLICIT SECRET DECLARATIONS
    # -------------------------------------------------------------------------
    # These are the secrets the reusable workflow expects to receive.
    # The caller MUST pass them explicitly unless using `secrets: inherit`.
    #
    # Required secrets must be provided or the workflow will fail.
    # Optional secrets can be omitted - the workflow handles their absence.
    # -------------------------------------------------------------------------
    secrets:
      deploy-token:
        description: >
          Token for deployment operations. Required for actual deployments.
          Can be a PAT, GitHub App token, or cloud provider token.
        required: true
      api-key:
        description: >
          API key for the target service. Optional - some operations
          work without it (with reduced functionality).
        required: false
      database-url:
        description: >
          Database connection string. Only needed for migration jobs.
        required: false
      notification-webhook:
        description: >
          Webhook URL for sending deployment notifications (Slack, Teams).
        required: false

    outputs:
      secrets-report:
        description: 'JSON report of which secrets were available'
        value: ${{ jobs.audit-secrets.outputs.report }}

permissions:
  contents: read
  deployments: write

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Audit which secrets are available
  # ---------------------------------------------------------------------------
  # This job checks and reports which secrets were passed through.
  # It NEVER reveals secret values - only their presence/absence.
  # ---------------------------------------------------------------------------
  audit-secrets:
    name: "Audit Secret Availability"
    runs-on: ubuntu-latest
    outputs:
      report: ${{ steps.audit.outputs.report }}
    steps:
      - name: "Check secret availability"
        id: audit
        run: |
          echo "=== SECRET AVAILABILITY AUDIT ==="
          echo ""

          # Check each declared secret
          DEPLOY_TOKEN_SET="false"
          API_KEY_SET="false"
          DATABASE_URL_SET="false"
          NOTIFICATION_WEBHOOK_SET="false"
          GITHUB_TOKEN_SET="false"

          if [ -n "$DEPLOY_TOKEN" ]; then
            DEPLOY_TOKEN_SET="true"
            echo "deploy-token: AVAILABLE"
          else
            echo "deploy-token: NOT SET"
          fi

          if [ -n "$API_KEY" ]; then
            API_KEY_SET="true"
            echo "api-key: AVAILABLE"
          else
            echo "api-key: NOT SET"
          fi

          if [ -n "$DATABASE_URL" ]; then
            DATABASE_URL_SET="true"
            echo "database-url: AVAILABLE"
          else
            echo "database-url: NOT SET"
          fi

          if [ -n "$NOTIFICATION_WEBHOOK" ]; then
            NOTIFICATION_WEBHOOK_SET="true"
            echo "notification-webhook: AVAILABLE"
          else
            echo "notification-webhook: NOT SET"
          fi

          if [ -n "$GH_TOKEN_CHECK" ]; then
            GITHUB_TOKEN_SET="true"
            echo "GITHUB_TOKEN: AVAILABLE"
          else
            echo "GITHUB_TOKEN: NOT SET"
          fi

          # Build JSON report
          REPORT=$(cat <<REPORT_EOF
          {
            "deploy-token": ${DEPLOY_TOKEN_SET},
            "api-key": ${API_KEY_SET},
            "database-url": ${DATABASE_URL_SET},
            "notification-webhook": ${NOTIFICATION_WEBHOOK_SET},
            "github-token": ${GITHUB_TOKEN_SET}
          }
          REPORT_EOF
          )
          echo "report=$(echo "$REPORT" | jq -c '.')" >> "$GITHUB_OUTPUT"

          # Summary
          echo ""
          echo "### Secrets Audit Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Secret | Available |" >> "$GITHUB_STEP_SUMMARY"
          echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
          echo "| deploy-token | ${DEPLOY_TOKEN_SET} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| api-key | ${API_KEY_SET} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| database-url | ${DATABASE_URL_SET} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| notification-webhook | ${NOTIFICATION_WEBHOOK_SET} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| GITHUB_TOKEN | ${GITHUB_TOKEN_SET} |" >> "$GITHUB_STEP_SUMMARY"
        env:
          DEPLOY_TOKEN: ${{ secrets.deploy-token }}
          API_KEY: ${{ secrets.api-key }}
          DATABASE_URL: ${{ secrets.database-url }}
          NOTIFICATION_WEBHOOK: ${{ secrets.notification-webhook }}
          GH_TOKEN_CHECK: ${{ secrets.GITHUB_TOKEN }}

  # ---------------------------------------------------------------------------
  # Job 2: Use secrets with environment protection
  # ---------------------------------------------------------------------------
  deploy-with-env:
    name: "Deploy (Environment-Protected)"
    runs-on: ubuntu-latest
    needs: audit-secrets
    if: inputs.environment != ''
    environment:
      name: ${{ inputs.environment }}
      url: "https://${{ inputs.environment }}.example.com"

    steps:
      - name: "Deploy with environment secrets"
        run: |
          echo "=== DEPLOYMENT ==="
          echo "Environment: ${{ inputs.environment }}"
          echo ""
          echo "At this point, environment-level secrets are available"
          echo "because this job has 'environment:' set."
          echo ""
          echo "Environment secrets override repo/org secrets of the same name."
        env:
          DEPLOY_TOKEN: ${{ secrets.deploy-token }}

      - name: "Notify deployment"
        if: env.HAS_WEBHOOK == 'true'
        run: |
          echo "Sending notification to webhook..."
          # curl -sf -X POST "$WEBHOOK_URL" -d '{"text":"Deployed to ${{ inputs.environment }}"}'
        env:
          HAS_WEBHOOK: ${{ secrets.notification-webhook != '' }}
          WEBHOOK_URL: ${{ secrets.notification-webhook }}

  # ---------------------------------------------------------------------------
  # Job 3: Demonstrate secret usage without environment
  # ---------------------------------------------------------------------------
  deploy-without-env:
    name: "Deploy (No Environment)"
    runs-on: ubuntu-latest
    needs: audit-secrets
    if: inputs.environment == ''

    steps:
      - name: "Deploy without environment protection"
        run: |
          echo "=== DEPLOYMENT (no environment) ==="
          echo ""
          echo "This job does NOT have 'environment:' set, so:"
          echo "  - No environment protection rules are enforced"
          echo "  - No environment-level secrets are available"
          echo "  - Only repo-level and org-level secrets are available"
          echo "  - And explicitly passed secrets from the caller"
        env:
          DEPLOY_TOKEN: ${{ secrets.deploy-token }}

  # ---------------------------------------------------------------------------
  # Job 4: Document calling patterns
  # ---------------------------------------------------------------------------
  calling-patterns:
    name: "Document Calling Patterns"
    runs-on: ubuntu-latest
    steps:
      - name: "Generate calling pattern documentation"
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ## How to Call This Reusable Workflow

          ### Pattern 1: Explicit Secret Passing
          ```yaml
          jobs:
            deploy:
              uses: owner/reusable-workflows/.github/workflows/secrets-inheritance.yml@main
              with:
                environment: production
                log-secret-availability: true
              secrets:
                deploy-token: ${{ secrets.DEPLOY_TOKEN }}
                api-key: ${{ secrets.API_KEY }}
                database-url: ${{ secrets.DATABASE_URL }}
                notification-webhook: ${{ secrets.SLACK_WEBHOOK }}
          ```

          ### Pattern 2: Inherit All Secrets
          ```yaml
          jobs:
            deploy:
              uses: owner/reusable-workflows/.github/workflows/secrets-inheritance.yml@main
              with:
                environment: production
              secrets: inherit
              # All repo and org secrets are passed automatically
              # GITHUB_TOKEN is passed with caller's permissions
          ```

          ### Pattern 3: Mixed (inherit + environment)
          ```yaml
          jobs:
            deploy:
              uses: owner/reusable-workflows/.github/workflows/secrets-inheritance.yml@main
              with:
                environment: production
              secrets: inherit
              # Note: Even with inherit, environment secrets come from
              # the reusable workflow's own 'environment:' key, not the caller
          ```

          ### Key Rules
          1. Without `secrets:` or `secrets: inherit`, no secrets are passed
          2. `secrets: inherit` passes ALL repo+org secrets + GITHUB_TOKEN
          3. `secrets: inherit` does NOT pass environment secrets
          4. The reusable workflow must use `environment:` to get env secrets
          5. GITHUB_TOKEN permissions come from the CALLER when using inherit
          EOF

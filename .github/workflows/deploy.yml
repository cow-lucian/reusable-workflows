# =============================================================================
# Reusable Deployment Workflow
# =============================================================================
# Deploys an application to a specified environment using the GitHub
# Deployments API for tracking. Supports dry-run mode.
#
# USAGE:
#   jobs:
#     deploy:
#       uses: <owner>/<repo>/.github/workflows/deploy.yml@main
#       with:
#         environment: 'production'
#         version: 'v1.2.3'
#         app-name: 'my-api'
#         dry-run: false
#       secrets:
#         deploy-token: ${{ secrets.DEPLOY_TOKEN }}
#         cloud-credentials: ${{ secrets.CLOUD_CREDENTIALS }}
# =============================================================================

name: Reusable Deploy

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target deployment environment (e.g. staging, production)'
        type: string
        required: true
      version:
        description: 'Version or image tag to deploy (e.g. v1.2.3, sha-abc1234)'
        type: string
        required: true
      dry-run:
        description: 'If true, simulate the deployment without making changes'
        type: boolean
        required: false
        default: false
      app-name:
        description: 'Application name used for resource identification'
        type: string
        required: true
    outputs:
      deployment-url:
        description: 'URL where the deployed application is accessible'
        value: ${{ jobs.deploy.outputs.deployment-url }}
      deployment-id:
        description: 'GitHub Deployment ID for status tracking'
        value: ${{ jobs.deploy.outputs.deployment-id }}
    secrets:
      deploy-token:
        description: 'Token used to authenticate deployment operations'
        required: true
      cloud-credentials:
        description: 'Cloud provider credentials (JSON or token)'
        required: false

permissions:
  contents: read
  deployments: write

jobs:
  deploy:
    name: Deploy ${{ inputs.app-name }} to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: ${{ steps.deploy.outputs.url }}
    outputs:
      deployment-url: ${{ steps.deploy.outputs.url }}
      deployment-id: ${{ steps.create-deployment.outputs.deployment-id }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create GitHub Deployment
        id: create-deployment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.deploy-token }}
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: '${{ inputs.environment }}',
              description: 'Deploy ${{ inputs.app-name }} ${{ inputs.version }} to ${{ inputs.environment }}',
              auto_merge: false,
              required_contexts: [],
              transient_environment: '${{ inputs.environment }}' !== 'production',
              production_environment: '${{ inputs.environment }}' === 'production',
            });
            core.setOutput('deployment-id', deployment.data.id);
            console.log(`Created deployment ${deployment.data.id}`);

      - name: Set deployment status to in_progress
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.deploy-token }}
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.create-deployment.outputs.deployment-id }},
              state: 'in_progress',
              description: 'Deployment in progress...',
            });

      - name: Configure cloud credentials
        if: secrets.cloud-credentials != ''
        run: |
          echo "Configuring cloud provider credentials..."
          # Store credentials securely for subsequent steps
          mkdir -p ~/.config
          echo '${{ secrets.cloud-credentials }}' > ~/.config/cloud-credentials.json
          chmod 600 ~/.config/cloud-credentials.json

      - name: Execute deployment
        id: deploy
        env:
          DEPLOY_TOKEN: ${{ secrets.deploy-token }}
          APP_NAME: ${{ inputs.app-name }}
          VERSION: ${{ inputs.version }}
          ENVIRONMENT: ${{ inputs.environment }}
          DRY_RUN: ${{ inputs.dry-run }}
        run: |
          echo "::group::Deployment details"
          echo "Application: ${APP_NAME}"
          echo "Version:     ${VERSION}"
          echo "Environment: ${ENVIRONMENT}"
          echo "Dry-run:     ${DRY_RUN}"
          echo "::endgroup::"

          if [ "${DRY_RUN}" = "true" ]; then
            echo ">>> DRY RUN MODE - no changes will be applied <<<"
            DEPLOY_URL="https://${APP_NAME}-${ENVIRONMENT}.example.com (dry-run)"
          else
            # ---------------------------------------------------------------
            # Replace this section with your actual deployment commands.
            # Examples:
            #   - kubectl set image deployment/${APP_NAME} app=${VERSION}
            #   - aws ecs update-service ...
            #   - gcloud run deploy ...
            #   - terraform apply ...
            # ---------------------------------------------------------------
            echo "Deploying ${APP_NAME}@${VERSION} to ${ENVIRONMENT}..."
            sleep 2  # Placeholder for actual deployment
            DEPLOY_URL="https://${APP_NAME}-${ENVIRONMENT}.example.com"
          fi

          echo "url=${DEPLOY_URL}" >> "$GITHUB_OUTPUT"
          echo "### Deployment Complete" >> "$GITHUB_STEP_SUMMARY"
          echo "| Field | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **App** | ${APP_NAME} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Version** | ${VERSION} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Environment** | ${ENVIRONMENT} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **URL** | ${DEPLOY_URL} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Dry-run** | ${DRY_RUN} |" >> "$GITHUB_STEP_SUMMARY"

      - name: Set deployment status to success
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.deploy-token }}
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.create-deployment.outputs.deployment-id }},
              state: 'success',
              environment_url: '${{ steps.deploy.outputs.url }}',
              description: 'Deployment succeeded',
            });

      - name: Set deployment status to failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.deploy-token }}
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.create-deployment.outputs.deployment-id }},
              state: 'failure',
              description: 'Deployment failed',
            });

      - name: Clean up credentials
        if: always()
        run: rm -f ~/.config/cloud-credentials.json
